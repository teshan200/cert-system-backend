<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wallet & Balance - University Dashboard</title>
  <script>
    // Early global error trap to catch synchronous load errors
    window.addEventListener('error', (event) => {
      console.error('üåã EARLY LOAD ERROR:', event.message, 'at', event.filename, 'line', event.lineno);
      if (event.error) {
        console.error('   Stack:', event.error.stack);
      }
    });
    window.addEventListener('unhandledrejection', (event) => {
      console.error('üåã EARLY UNHANDLED REJECTION:', event.reason);
      console.error('   Stack:', event.reason?.stack);
    });
  </script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f7fa;
      min-height: 100vh;
      display: flex;
    }

    .sidebar {
      width: 240px;
      background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      display: flex;
      flex-direction: column;
      padding: 24px 20px;
      box-shadow: 4px 0 20px rgba(0,0,0,0.08);
      position: sticky;
      top: 0;
      height: 100vh;
    }

    .sidebar h1 {
      font-size: 20px;
      margin-bottom: 24px;
    }

    .sidebar .nav-link {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      margin-bottom: 8px;
      border-radius: 8px;
      color: #fff;
      text-decoration: none;
      background: rgba(255,255,255,0.06);
      transition: background 0.2s;
      font-size: 14px;
    }

    .sidebar .nav-link:hover,
    .sidebar .nav-link.active {
      background: rgba(255,255,255,0.12);
    }

    .sidebar .logout-btn {
      margin-top: auto;
      background: rgba(255,255,255,0.16);
      border: 1px solid rgba(255,255,255,0.3);
      color: #fff;
      padding: 10px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
    }

    .main {
      flex: 1;
      padding: 24px 28px;
    }

    .page-header {
      background: #fff;
      color: #333;
      padding: 20px 24px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
      margin-bottom: 24px;
    }

    .page-header h1 {
      font-size: 24px;
      margin-bottom: 8px;
    }

    .page-header p {
      color: #666;
      font-size: 14px;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
    }

    .section {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
    }

    .section h3 {
      font-size: 20px;
      margin-bottom: 20px;
      color: #333;
      border-bottom: 2px solid #f0f0f0;
      padding-bottom: 15px;
    }

    .balance-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      border-radius: 12px;
      margin-bottom: 30px;
    }

    .balance-card h4 {
      font-size: 14px;
      opacity: 0.9;
      margin-bottom: 8px;
      text-transform: uppercase;
    }

    .balance-card .amount {
      font-size: 48px;
      font-weight: bold;
      margin-bottom: 15px;
    }

    .balance-card .currency {
      font-size: 16px;
      opacity: 0.9;
    }

    .balance-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .balance-info {
      background: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }

    .balance-info h5 {
      color: #666;
      font-size: 12px;
      text-transform: uppercase;
      margin-bottom: 8px;
    }

    .balance-info .value {
      font-size: 24px;
      font-weight: bold;
      color: #333;
      margin-bottom: 4px;
    }

    .balance-info .subtext {
      font-size: 12px;
      color: #999;
    }

    .wallet-address {
      background: #f0f4ff;
      padding: 12px 16px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      word-break: break-all;
      color: #333;
      margin-bottom: 15px;
    }

    .copy-btn {
      padding: 6px 12px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      margin-top: 10px;
    }

    .copy-btn:hover {
      opacity: 0.9;
    }

    .topup-btn {
      padding: 12px 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      margin-top: 15px;
    }

    .topup-btn:hover {
      opacity: 0.9;
    }

    .info-box {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
      padding: 16px;
      margin-bottom: 20px;
      border-radius: 4px;
    }

    .info-box h4 {
      margin-bottom: 8px;
      color: #1976d2;
    }

    .info-box p {
      color: #555;
      font-size: 14px;
      line-height: 1.6;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .spinner {
      border: 4px solid #f0f0f0;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error-box {
      background: #fee;
      border-left: 4px solid #f44336;
      padding: 16px;
      margin-bottom: 20px;
      border-radius: 4px;
      color: #c00;
    }

    .success-box {
      background: #efe;
      border-left: 4px solid #4caf50;
      padding: 16px;
      margin-bottom: 20px;
      border-radius: 4px;
      color: #060;
    }

    @media (max-width: 768px) {
      body {
        flex-direction: column;
      }

      .sidebar {
        position: relative;
        width: 100%;
        height: auto;
        flex-direction: row;
        flex-wrap: wrap;
        gap: 8px;
        padding: 16px;
      }

      .sidebar h1 {
        width: 100%;
        margin-bottom: 8px;
      }

      .sidebar .nav-link {
        flex: 1 1 30%;
        justify-content: center;
      }

      .sidebar .logout-btn {
        width: 100%;
      }

      .main {
        padding: 16px;
      }

      .balance-card .amount {
        font-size: 32px;
      }

      .balance-row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <h1>üè´ University</h1>
    <a class="nav-link" href="overview.html">üè† Overview</a>
    <a class="nav-link" href="issue-certificate.html">üìú Issue Certificate</a>
    <a class="nav-link" href="bulk-upload.html">üì§ Bulk Upload</a>
    <a class="nav-link" href="history.html">üìö History</a>
    <a class="nav-link active" href="wallet.html">üí≥ Wallet & Balance</a>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>

  <div class="main">
    <div class="page-header">
      <h1>üí≥ Wallet & Balance Management</h1>
      <p>View your prepaid balance and manage certificate issuance funds</p>
    </div>

    <div class="container">
      <!-- Balance Card -->
      <div id="balanceCard" class="balance-card" style="display: none;">
        <h4>Current Balance</h4>
        <div class="amount" id="balanceAmount">0.00</div>
        <div class="currency">Polygon (POL)</div>
      </div>

      <!-- Loading State -->
      <div id="loadingState" class="section">
        <div class="loading">
          <div class="spinner"></div>
          <p>Loading wallet information...</p>
        </div>
      </div>

      <!-- Error State -->
      <div id="errorState" style="display: none;">
        <div class="error-box" id="errorMessage"></div>
      </div>

      <!-- Balance Details -->
      <div id="balanceDetails" style="display: none;">
        <div class="section">
          <h3>Wallet Address</h3>
          <div class="wallet-address" id="walletAddress">‚Äî</div>
          <button class="copy-btn" onclick="copyToClipboard()">Copy Address</button>
        </div>

        <div class="section">
          <h3>Balance Breakdown</h3>
          <div class="balance-row">
            <div class="balance-info">
              <h5>Prepaid Balance</h5>
              <div class="value" id="prepaidBalance">0.00</div>
              <div class="subtext">POL available for certificates</div>
            </div>
            <div class="balance-info">
              <h5>Total Gas Spent</h5>
              <div class="value" id="gasSpent">0.00</div>
              <div class="subtext">POL consumed for issuance</div>
            </div>
          </div>
        </div>

        <div class="section">
          <h3>Top-up Your Balance</h3>
          <div class="info-box">
            <h4>How to Top-up</h4>
            <p>
              Connect your MetaMask wallet and deposit Polygon (POL) tokens directly to your contract balance. 
              Each certificate issuance will deduct gas fees from your prepaid balance.
            </p>
          </div>

          <!-- MetaMask Connection Section -->
          <div id="metamaskSection" style="margin-bottom: 20px;">
            <div id="metamaskStatus" style="background: #f0f4ff; padding: 12px; border-radius: 8px; border-left: 4px solid #2196f3; margin-bottom: 15px;">
              <p><strong>MetaMask Status:</strong> <span id="statusText">Checking...</span></p>
              <p id="accountText" style="font-family: monospace; font-size: 12px; word-break: break-all; margin-top: 5px;"></p>
            </div>

            <!-- Top-up Form -->
            <div id="topupForm" style="display: block;">
              <div style="margin-bottom: 15px;">
                <label for="topupAmount" style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
                  Amount (POL)
                </label>
                <input 
                  type="number" 
                  id="topupAmount" 
                  placeholder="Enter amount to deposit"
                  min="0.001"
                  step="0.001"
                  style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;"
                >
              </div>
              <button class="topup-btn" id="btnDeposit" onclick="depositPOL()" style="width: 100%;">
                üí≥ Deposit POL
              </button>
              <div id="depositMessage" style="margin-top: 15px; display: none;"></div>
            </div>
          </div>
        </div>

        <div class="section">
          <h3>Certificate Cost Estimation</h3>
          <div class="info-box">
            <h4>Average Gas Cost</h4>
            <div style="margin-top: 10px;">
              <div style="margin-bottom: 10px;">
                <strong id="gasCostPerCert">‚Äî</strong> POL per certificate
              </div>
              <small style="color: #666;">
                Actual cost may vary based on network conditions. Single issuance: ~1 cert. Bulk issuance: ~0.5 POL per cert (average).
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script>
    console.log('üîß wallet.html inline script starting...');
    
    // Contract ABI for CertificateVerificationNoNonce (deployed on Polygon Amoy)
    const CONTRACT_ABI = [
      { "inputs": [], "name": "depositGasFund", "outputs": [], "stateMutability": "payable", "type": "function" },
      { "inputs": [ { "internalType": "address", "name": "", "type": "address" } ], "name": "universityBalance", "outputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ], "stateMutability": "view", "type": "function" },
      { "inputs": [], "name": "gasLimitPerCertificate", "outputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ], "stateMutability": "view", "type": "function" },
      { "inputs": [], "name": "gasPriceForCertificate", "outputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ], "stateMutability": "view", "type": "function" }
    ];

    const CONTRACT_ADDRESS = '0x13660206fF34b48b07422a6658BfD93242b6a126';
    const POLYGON_AMOY_CHAIN_ID = '0x13882'; // 80002 in hex

    let provider, signer, contract, userAddress;

    console.log('‚úì Global vars initialized');

    // Check authentication
    window.addEventListener('load', async () => {
      try {
        console.log('üìç window.load event fired');
        const token = localStorage.getItem('token');
        if (!token) {
          window.location.href = '/university/login';
          return;
        }

        // Load initial info (these don't need to wait)
        loadWalletInfo();
        loadGasCost();
        
        // Check MetaMask connection - this is async and must complete
        await checkMetaMaskConnection();
        console.log('‚úì window.load handlers called');
      } catch (err) {
        console.error('‚ùå Error in window.load:', err);
      }
    });

    // Ensure we are on Polygon Amoy and MetaMask is connected
    async function ensurePolygonNetwork() {
      try {
        const chainId = await window.ethereum.request({ method: 'eth_chainId' });
        if (chainId === POLYGON_AMOY_CHAIN_ID) return;

        try {
          await window.ethereum.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: POLYGON_AMOY_CHAIN_ID }],
          });
        } catch (switchError) {
          if (switchError.code === 4902) {
            await window.ethereum.request({
              method: 'wallet_addEthereumChain',
              params: [{
                chainId: POLYGON_AMOY_CHAIN_ID,
                chainName: 'Polygon Amoy Testnet',
                rpcUrls: ['https://rpc-amoy.polygon.technology'],
                nativeCurrency: { name: 'Polygon', symbol: 'POL', decimals: 18 },
                blockExplorerUrls: ['https://amoy.polygonscan.com']
              }],
            });
          } else {
            throw switchError;
          }
        }
      } catch (err) {
        console.error('ensurePolygonNetwork error:', err);
        throw err;
      }
    }

    // Check if MetaMask is already connected and on correct network
    async function checkMetaMaskConnection() {
      try {
        console.log('üîê checkMetaMaskConnection called');
        if (typeof window.ethereum === 'undefined') {
          console.log('‚ùå window.ethereum undefined');
          updateMetaMaskStatus('MetaMask not installed', false);
          return;
        }

        console.log('üìç Requesting accounts...');
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        if (!accounts.length) {
          console.log('‚ùå No accounts found');
          updateMetaMaskStatus('No accounts connected', false);
          return;
        }

        userAddress = accounts[0];
        console.log('‚úì userAddress set:', userAddress);
        
        console.log('üìç Ensuring Polygon network...');
        await ensurePolygonNetwork();
        console.log('‚úì Network OK');

        console.log('üìç Creating ethers provider...');
        provider = new ethers.providers.Web3Provider(window.ethereum);
        console.log('‚úì Provider created');
        
        console.log('üìç Getting signer...');
        signer = provider.getSigner();
        console.log('‚úì Signer created');
        
        console.log('üìç Creating contract instance...');
        contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
        console.log('‚úì Contract created');
        
        console.log('‚úì Updating UI...');
        updateMetaMaskStatus('Connected: ' + userAddress, true);
        console.log('‚úì checkMetaMaskConnection complete');
      } catch (error) {
        console.error('‚ùå checkMetaMaskConnection error:', error);
        console.error('   Message:', error?.message);
        console.error('   Stack:', error?.stack);
        updateMetaMaskStatus('Connection failed: ' + (error.message || 'unknown error'), false);
      }
    }

    // Update MetaMask status display
    function updateMetaMaskStatus(text, isConnected) {
      const statusDiv = document.getElementById('metamaskStatus');

      if (isConnected) {
        statusDiv.style.borderLeftColor = '#4caf50';
        statusDiv.style.background = '#f1f8f4';
        document.getElementById('statusText').textContent = '‚úÖ Connected';
        document.getElementById('accountText').textContent = 'Account: ' + userAddress;
      } else {
        statusDiv.style.borderLeftColor = '#f44336';
        statusDiv.style.background = '#fee';
        document.getElementById('statusText').textContent = '‚ùå ' + text;
        document.getElementById('accountText').textContent = '';
      }
    }

    // Deposit POL to contract
    async function depositPOL() {
      if (!userAddress) {
        showDepositMessage('Please connect MetaMask first', 'error');
        return;
      }

      // Always ensure we are on Polygon Amoy before sending
      try {
        await ensurePolygonNetwork();
        provider = new ethers.providers.Web3Provider(window.ethereum);
        signer = provider.getSigner(userAddress);
        contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
      } catch (netErr) {
        showDepositMessage('Please switch to Polygon Amoy in MetaMask', 'error');
        return;
      }

      const amount = document.getElementById('topupAmount').value.trim();
      if (!amount || Number(amount) <= 0) {
        showDepositMessage('Please enter a valid amount', 'error');
        return;
      }

      const btn = document.getElementById('btnDeposit');
      btn.disabled = true;
      btn.textContent = '‚è≥ Processing...';

      try {
        // Diagnose current network and balance
        const net = await provider.getNetwork();
        const bal = await signer.getBalance();
        const balPol = ethers.utils.formatEther(bal);
        console.log('Network', net, 'Balance POL', balPol);

        const amountWei = ethers.utils.parseEther(amount);
        
        // Try to estimate gas first to get better error message
        try {
          const gasEstimate = await contract.estimateGas.depositGasFund({
            value: amountWei
          });
          console.log('Gas estimate:', gasEstimate.toString());
          
          // Get current gas price
          const gasPrice = await provider.getGasPrice();
          const gasPricePol = ethers.utils.formatEther(gasPrice);
          const gasCostPol = ethers.utils.formatEther(gasEstimate.mul(gasPrice));
          const totalCostPol = (parseFloat(amount) + parseFloat(gasCostPol)).toFixed(6);
          
          console.log('Gas price (POL):', gasPricePol);
          console.log('Gas cost (POL):', gasCostPol);
          console.log('Deposit amount (POL):', amount);
          console.log('Total cost (POL):', totalCostPol);
          console.log('Your balance (POL):', balPol);
          
          if (parseFloat(totalCostPol) > parseFloat(balPol)) {
            showDepositMessage('‚ùå Insufficient balance. Need: ' + totalCostPol + ' POL (deposit + gas), Have: ' + balPol + ' POL', 'error');
            return;
          }
        } catch (gasErr) {
          console.error('Gas estimation failed:', gasErr);
          showDepositMessage('‚ùå Contract call failed. Details: ' + (gasErr.reason || gasErr.message), 'error');
          return;
        }
        
        // Call depositGasFund with amount as value, with explicit gas limit
        const tx = await contract.depositGasFund({
          value: amountWei,
          gasLimit: ethers.BigNumber.from('150000')
        });

        showDepositMessage('Transaction submitted: ' + tx.hash.substring(0, 10) + '...', 'info');
        
        // Wait for confirmation
        const receipt = await tx.wait();
        
        showDepositMessage('‚úÖ Deposit successful! ' + amount + ' POL deposited.', 'success');
        document.getElementById('topupAmount').value = '';
        
        // Refresh balance
        setTimeout(() => {
          loadWalletInfo();
        }, 2000);
      } catch (error) {
        console.error('Deposit error:', error);
        // Provide clearer guidance for RPC failures
        const msg = error && error.message ? error.message : 'Unknown error';
        const dataMsg = error && error.data && error.data.message ? error.data.message : '';
        const details = dataMsg ? `${msg} | ${dataMsg}` : msg;
        showDepositMessage('‚ùå Deposit failed. Check: on Polygon Amoy, have POL balance, try smaller amount. Details: ' + details, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'üí≥ Deposit POL';
      }
    }

    // Show deposit message
    function showDepositMessage(text, type) {
      const msgDiv = document.getElementById('depositMessage');
      msgDiv.style.display = 'block';
      
      if (type === 'error') {
        msgDiv.style.background = '#fee';
        msgDiv.style.color = '#c00';
        msgDiv.style.borderLeft = '4px solid #f44336';
      } else if (type === 'success') {
        msgDiv.style.background = '#efe';
        msgDiv.style.color = '#060';
        msgDiv.style.borderLeft = '4px solid #4caf50';
      } else {
        msgDiv.style.background = '#e3f2fd';
        msgDiv.style.color = '#1976d2';
        msgDiv.style.borderLeft = '4px solid #2196f3';
      }
      
      msgDiv.textContent = text;
      msgDiv.style.padding = '12px';
      msgDiv.style.borderRadius = '4px';
    }

    // Load wallet balance and info
    async function loadWalletInfo() {
      try {
        const token = localStorage.getItem('token');
        
        // Get institute info first
        const dashResponse = await fetch('/api/university/dashboard', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!dashResponse.ok) {
          throw new Error('Failed to load institute information');
        }

        const dashData = await dashResponse.json();
        const walletAddress = dashData.institute.wallet_address;

        if (!walletAddress) {
          showError('No wallet address assigned to your institution. Please contact support.');
          return;
        }

        // Get balance from payment endpoint
        const balanceResponse = await fetch(`/api/payment/balance?address=${walletAddress}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!balanceResponse.ok) {
          throw new Error('Failed to load balance information');
        }

        const balanceData = await balanceResponse.json();

        // Show balance card
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('balanceDetails').style.display = 'block';
        document.getElementById('balanceCard').style.display = 'block';

        // Update UI
        const balancePol = parseFloat(balanceData.data.balancePol).toFixed(4);
        const gasSpentPol = parseFloat(balanceData.data.gasSpentPol).toFixed(4);

        document.getElementById('walletAddress').textContent = walletAddress;
        document.getElementById('balanceAmount').textContent = balancePol;
        document.getElementById('prepaidBalance').textContent = balancePol;
        document.getElementById('gasSpent').textContent = gasSpentPol;

      } catch (error) {
        console.error('Wallet load error:', error);
        showError(error.message || 'Failed to load wallet information');
      }
    }

    // Load gas cost per certificate
    async function loadGasCost() {
      try {
        const response = await fetch('/api/payment/gas-cost');
        
        if (!response.ok) {
          throw new Error('Failed to load gas cost');
        }

        const data = await response.json();
        const costPol = parseFloat(data.data.pol).toFixed(6);
        document.getElementById('gasCostPerCert').textContent = costPol;

      } catch (error) {
        console.error('Gas cost error:', error);
        document.getElementById('gasCostPerCert').textContent = 'Unable to load';
      }
    }

    function showError(message) {
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('errorState').style.display = 'block';
      document.getElementById('errorMessage').textContent = '‚ùå ' + message;
    }

    function copyToClipboard() {
      const address = document.getElementById('walletAddress').textContent;
      if (address === '‚Äî') return;

      navigator.clipboard.writeText(address).then(() => {
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = '‚úÖ Copied!';
        setTimeout(() => {
          btn.textContent = originalText;
        }, 2000);
      }).catch(() => {
        alert('Failed to copy address');
      });
    }

    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('institute_id');
      localStorage.removeItem('institute_name');
      window.location.href = '/';
    }
  </script>
  
  <script src="/metamask-integration.js"></script>
</body>
</html>
